name: Deploy Backend & Frontend

on:
  push:
    branches:
      - main
      - develop

env:
  NODE_VERSION: '20'

jobs:
  deploy:
    runs-on: self-hosted
    timeout-minutes: 90   # only safety net, NOT used by script

    steps:
    # =====================================================
    # Checkout
    # =====================================================
    - name: Checkout repository
      uses: actions/checkout@v4

    # =====================================================
    # Determine Environment
    # =====================================================
    - name: Determine environment
      id: env
      run: |
        if [ "${{ github.ref }}" = "refs/heads/main" ]; then
          echo "ENV=production" >> $GITHUB_OUTPUT
          echo "PREFIX=PROD" >> $GITHUB_OUTPUT
          echo "Deploying to PRODUCTION"
        else
          echo "ENV=development" >> $GITHUB_OUTPUT
          echo "PREFIX=DEV" >> $GITHUB_OUTPUT
          echo "Deploying to DEVELOPMENT"
        fi

    # =====================================================
    # BACKEND DEPLOYMENT (Azure App Service)
    # =====================================================
    - name: Setup Node (Backend)
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Install backend dependencies
      working-directory: backend
      run: npm ci

    - name: Package backend
      working-directory: backend
      run: |
        zip -r ../backend.zip . -x node_modules/\* .git/\*
        ls -lh ../backend.zip

    - name: Azure login
      uses: azure/login@v2
      with:
        creds: ${{ steps.env.outputs.PREFIX == 'PROD' && secrets.PROD_AZURE_CREDS || secrets.DEV_AZURE_CREDS }}

    - name: Deploy backend to App Service
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ steps.env.outputs.PREFIX == 'PROD' && secrets.PROD_AZURE_WEBAPP_NAME || secrets.DEV_AZURE_WEBAPP_NAME }}
        package: backend.zip
        startup-command: "npm start"

    - name: Restart backend
      run: |
        az webapp restart \
          --name ${{ steps.env.outputs.PREFIX == 'PROD' && secrets.PROD_AZURE_WEBAPP_NAME || secrets.DEV_AZURE_WEBAPP_NAME }} \
          --resource-group ${{ steps.env.outputs.PREFIX == 'PROD' && secrets.PROD_AZURE_RESOURCE_GROUP || secrets.DEV_AZURE_RESOURCE_GROUP }}

    # =====================================================
    # FRONTEND BUILD
    # =====================================================
    - name: Setup Node (Frontend)
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Install frontend dependencies
      working-directory: frontend
      run: npm ci

    - name: Build frontend
      working-directory: frontend
      env:
        VITE_API_BASE_URL: ${{ steps.env.outputs.PREFIX == 'PROD' && secrets.PROD_VITE_API_BASE_URL || secrets.DEV_VITE_API_BASE_URL }}
        VITE_MSAL_CLIENT_ID: ${{ steps.env.outputs.PREFIX == 'PROD' && secrets.PROD_VITE_MSAL_CLIENT_ID || secrets.DEV_VITE_MSAL_CLIENT_ID }}
        VITE_MSAL_TENANT_ID: ${{ steps.env.outputs.PREFIX == 'PROD' && secrets.PROD_VITE_MSAL_TENANT_ID || secrets.DEV_VITE_MSAL_TENANT_ID }}
      run: |
        npm run build
        du -sh dist

    # =====================================================
    # FRONTEND DEPLOY (WAIT UNTIL FINISHED)
    # =====================================================
    - name: Deploy frontend to Static Web Apps (wait until finished)
      working-directory: frontend
      env:
        DEPLOY_TOKEN: ${{ steps.env.outputs.PREFIX == 'PROD' && secrets.PROD_AZURE_STATIC_WEB_APP_DEPLOYMENT_TOKEN || secrets.DEV_AZURE_STATIC_WEB_APP_DEPLOYMENT_TOKEN }}
        SWA_NAME: ${{ steps.env.outputs.PREFIX == 'PROD' && secrets.PROD_AZURE_STATIC_WEB_APP_NAME || secrets.DEV_AZURE_STATIC_WEB_APP_NAME }}
        RESOURCE_GROUP: ${{ steps.env.outputs.PREFIX == 'PROD' && secrets.PROD_AZURE_RESOURCE_GROUP || secrets.DEV_AZURE_RESOURCE_GROUP }}
        ENVIRONMENT: ${{ steps.env.outputs.ENV }}
      run: |
        set -euo pipefail

        echo "üöÄ Triggering Static Web App deployment"
        echo "Environment: $ENVIRONMENT"
        echo "App: $SWA_NAME"

        START_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        echo "Deployment start time: $START_TIME"

        npx --yes @azure/static-web-apps-cli deploy ./dist \
          --deployment-token "$DEPLOY_TOKEN" \
          --env "$ENVIRONMENT" \
          --no-use-keychain

        echo "üì° Deployment triggered. Waiting for Azure to complete..."

        while true; do
          sleep 15

          STATUS=$(az staticwebapp deployment list \
            --name "$SWA_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --query "[?properties.createdOn >= '$START_TIME'] | sort_by(@, &properties.createdOn) | [-1].properties.status" \
            -o tsv 2>/dev/null || echo "")

          if [ "$STATUS" = "Succeeded" ]; then
            echo "‚úÖ Frontend deployment completed successfully"
            break
          fi

          if [ "$STATUS" = "Failed" ]; then
            echo "‚ùå Frontend deployment FAILED"
            exit 1
          fi

          echo "‚è≥ Still deploying... (status: ${STATUS:-unknown})"
        done

    # =====================================================
    # CLEANUP
    # =====================================================
    - name: Cleanup
      if: always()
      run: |
        rm -f backend.zip
        echo "Deployment completed for ${{ steps.env.outputs.ENV }}"
