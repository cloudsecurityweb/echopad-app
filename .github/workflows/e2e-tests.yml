name: E2E Tests

on:
  # Run AFTER deployment workflow completes successfully
  workflow_run:
    workflows: ["Build, Scan, Publish & Deploy"]
    types:
      - completed
    branches: [main, develop]
  
  # Manual trigger for on-demand testing
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test against'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - development
  
  # Daily scheduled regression tests
  schedule:
    - cron: '0 6 * * *'

env:
  # Production: calm-smoke (main branch), Development: polite-ground (develop branch)
  # For workflow_run, use the triggering workflow's branch
  FRONTEND_URL_PROD: 'https://calm-smoke-0ef35d31e.4.azurestaticapps.net'
  FRONTEND_URL_DEV: 'https://polite-ground-0602c481e.2.azurestaticapps.net'
  API_URL_PROD: 'https://echopad-backend.azurewebsites.net'
  API_URL_DEV: 'https://echopad-backend.azurewebsites.net'

jobs:
  e2e-tests:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Only run if deployment was successful (for workflow_run trigger)
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine environment
        id: env
        run: |
          # For workflow_run, get branch from triggering workflow
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            BRANCH="${{ github.event.workflow_run.head_branch }}"
          else
            BRANCH="${{ github.ref_name }}"
          fi
          
          echo "Branch: $BRANCH"
          
          if [ "$BRANCH" == "main" ]; then
            echo "FRONTEND_URL=${{ env.FRONTEND_URL_PROD }}" >> $GITHUB_OUTPUT
            echo "API_URL=${{ env.API_URL_PROD }}" >> $GITHUB_OUTPUT
            echo "ENV=production" >> $GITHUB_OUTPUT
          else
            echo "FRONTEND_URL=${{ env.FRONTEND_URL_DEV }}" >> $GITHUB_OUTPUT
            echo "API_URL=${{ env.API_URL_DEV }}" >> $GITHUB_OUTPUT
            echo "ENV=development" >> $GITHUB_OUTPUT
          fi

      - name: Log test environment
        run: |
          echo "ðŸ§ª Running E2E tests"
          echo "ðŸ“ Environment: ${{ steps.env.outputs.ENV }}"
          echo "ðŸŒ Frontend URL: ${{ steps.env.outputs.FRONTEND_URL }}"
          echo "ðŸ”Œ API URL: ${{ steps.env.outputs.API_URL }}"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: e2e/package.json

      - name: Install dependencies
        working-directory: e2e
        run: npm ci

      - name: Install Playwright browsers
        working-directory: e2e
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: Run E2E tests
        working-directory: e2e
        run: npx playwright test --project=${{ matrix.browser }}
        env:
          FRONTEND_URL: ${{ steps.env.outputs.FRONTEND_URL }}
          API_URL: ${{ steps.env.outputs.API_URL }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ matrix.browser }}
          path: e2e/playwright-report/
          retention-days: 30

      - name: Upload test artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts-${{ matrix.browser }}
          path: |
            e2e/test-results/
            e2e/screenshots/
          retention-days: 7

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: e2e-tests
    if: always()
    
    steps:
      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            BRANCH="${{ github.event.workflow_run.head_branch }}"
          else
            BRANCH="${{ github.ref_name }}"
          fi
          
          if [ "$BRANCH" == "main" ]; then
            echo "FRONTEND_URL=${{ env.FRONTEND_URL_PROD }}" >> $GITHUB_OUTPUT
            echo "API_URL=${{ env.API_URL_PROD }}" >> $GITHUB_OUTPUT
          else
            echo "FRONTEND_URL=${{ env.FRONTEND_URL_DEV }}" >> $GITHUB_OUTPUT
            echo "API_URL=${{ env.API_URL_DEV }}" >> $GITHUB_OUTPUT
          fi

      - name: Download all reports
        uses: actions/download-artifact@v4
        with:
          path: reports
          pattern: playwright-report-*

      - name: Generate summary
        run: |
          echo "## E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Browser | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          
          for browser in chromium firefox webkit; do
            if [ -d "reports/playwright-report-$browser" ]; then
              echo "| $browser | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $browser | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Environment" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ${{ steps.env.outputs.FRONTEND_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "- API: ${{ steps.env.outputs.API_URL }}" >> $GITHUB_STEP_SUMMARY

  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: e2e-tests
    if: failure() && github.ref == 'refs/heads/main'
    
    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const title = `E2E Tests Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            ## E2E Test Failure Alert
            
            The E2E tests have failed on the main branch.
            
            **Run ID:** ${{ github.run_id }}
            **Commit:** ${{ github.sha }}
            **Branch:** ${{ github.ref_name }}
            
            [View Run Details](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            Please investigate and fix the failing tests.
            `;
            
            // Check if similar issue exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'e2e-failure'
            });
            
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['e2e-failure', 'bug', 'automated']
              });
            }
