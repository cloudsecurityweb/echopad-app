name: Deploy Application

on:
  push:
    branches:
      - main
      - develop

env:
  NODE_VERSION: '20'

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Test Runner
        run: |
          echo "‚úÖ Runner is working!"
          echo "OS: $(uname -a)"
          echo "User: $(whoami)"
          echo "PWD: $(pwd)"
          echo "Git version: $(git --version 2>&1 || echo 'Git not found')"
          echo "Node version: $(node --version 2>&1 || echo 'Node not found')"
          echo "NPM version: $(npm --version 2>&1 || echo 'NPM not found')"
          echo "Azure CLI: $(az --version 2>&1 | head -1 || echo 'Azure CLI not found')"
          ls -la
          echo "‚úÖ Test step completed"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine Environment
        id: env
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "env=production" >> $GITHUB_OUTPUT
            echo "prefix=PROD" >> $GITHUB_OUTPUT
            echo "‚úÖ Deploying to PRODUCTION"
          else
            echo "env=development" >> $GITHUB_OUTPUT
            echo "prefix=DEV" >> $GITHUB_OUTPUT
            echo "‚úÖ Deploying to DEVELOPMENT"
          fi
          echo "Branch: ${{ github.ref_name }}"
          echo "Ref: ${{ github.ref }}"

      # Deploy Backend
      - name: Setup Node.js for Backend
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Backend Dependencies
        working-directory: ./backend
        run: npm ci

      - name: Create Backend Deployment Package
        working-directory: ./backend
        run: |
          zip -r ../backend-deploy.zip . \
            -x "node_modules/*" \
            -x ".git/*" \
            -x "*.log" \
            -x "*.md" \
            -x ".env*" \
            -x "test-*.js" \
            -x "*.spec.js" \
            -x ".DS_Store" \
            -x "*.zip" \
            -x "*.sh" \
            -x "*.ps1" \
            -x "create-*.ps1" \
            > /dev/null 2>&1
          echo "‚úÖ Backend package created"
          ls -lh ../backend-deploy.zip || echo "‚ùå Package not found!"

      - name: Verify Secrets
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            if [ -z "${{ secrets.PROD_AZURE_CREDS }}" ]; then
              echo "‚ùå ERROR: PROD_AZURE_CREDS secret is missing!"
              exit 1
            fi
            echo "‚úÖ PROD secrets verified"
          else
            if [ -z "${{ secrets.DEV_AZURE_CREDS }}" ]; then
              echo "‚ùå ERROR: DEV_AZURE_CREDS secret is missing!"
              exit 1
            fi
            echo "‚úÖ DEV secrets verified"
          fi

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_CREDS || secrets.DEV_AZURE_CREDS }}

      - name: Verify Azure Access and Set Subscription
        run: |
          echo "üîç Verifying Azure access and subscription..."
          echo ""
          
          # Show current account
          echo "Current Azure account:"
          az account show --query "{name:name, id:id, tenantId:tenantId}" -o table || {
            echo "‚ùå Cannot get account info"
            exit 1
          }
          
          # Set correct subscription based on environment
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            # PROD subscription
            SUBSCRIPTION_ID="c9ca9a88-e079-4b0d-a4ad-ed340a5d30fb"
            echo ""
            echo "Setting PROD subscription: $SUBSCRIPTION_ID"
          else
            # DEV subscription
            SUBSCRIPTION_ID="c31376b6-ec72-4a1a-9fb6-ec8c53edf6d2"
            echo ""
            echo "Setting DEV subscription: $SUBSCRIPTION_ID"
          fi
          
          az account set --subscription "$SUBSCRIPTION_ID"
          echo "‚úÖ Subscription set"
          
          # Verify we can access the Static Web App
          SWA_NAME="${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_STATIC_WEB_APP_NAME || secrets.DEV_AZURE_STATIC_WEB_APP_NAME }}"
          RESOURCE_GROUP="${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_RESOURCE_GROUP || secrets.DEV_AZURE_RESOURCE_GROUP }}"
          
          echo ""
          echo "Testing access to Static Web App:"
          echo "   Name: $SWA_NAME"
          echo "   Resource Group: $RESOURCE_GROUP"
          
          SWA_ACCESS=$(az staticwebapp show \
            --name "$SWA_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --query "name" -o tsv 2>&1)
          
          if echo "$SWA_ACCESS" | grep -q "ResourceNotFound\|NotFound\|AuthorizationFailed\|Forbidden"; then
            echo "   ‚ùå Cannot access Static Web App!"
            echo "   Error: $SWA_ACCESS"
            echo "   This indicates cross-account or permission issue"
            echo "   Deployment will work via token, but status checking will fail"
          else
            echo "   ‚úÖ Can access Static Web App: $SWA_ACCESS"
          fi

      - name: Verify Azure Connectivity
        continue-on-error: true
        run: |
          echo "üîç Verifying Azure connectivity and subscription access..."
          echo ""
          
          # Show current account and subscription
          echo "üìã Current Azure account:"
          if az account show --query "{name:name, id:id, tenantId:tenantId}" -o table 2>&1; then
            echo "‚úÖ Account info retrieved"
          else
            echo "‚ö†Ô∏è  Warning: Cannot get account info (non-critical)"
          fi
          
          # List available subscriptions
          echo ""
          echo "üìã Available subscriptions:"
          if az account list --query "[].{name:name, id:id, isDefault:isDefault}" -o table 2>&1; then
            echo "‚úÖ Subscriptions listed"
          else
            echo "‚ö†Ô∏è  Warning: Cannot list subscriptions (non-critical)"
          fi
          
          # Get Static Web App details
          SWA_NAME="${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_STATIC_WEB_APP_NAME || secrets.DEV_AZURE_STATIC_WEB_APP_NAME }}"
          RESOURCE_GROUP="${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_RESOURCE_GROUP || secrets.DEV_AZURE_RESOURCE_GROUP }}"
          
          echo ""
          echo "üîç Checking access to Static Web App:"
          echo "   Name: $SWA_NAME"
          echo "   Resource Group: $RESOURCE_GROUP"
          
          # Try to get the Static Web App
          SWA_INFO=$(az staticwebapp show \
            --name "$SWA_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --query "{name:name, defaultHostname:defaultHostname, location:location}" -o json 2>&1)
          
          SWA_EXIT_CODE=$?
          
          if [ $SWA_EXIT_CODE -ne 0 ] || echo "$SWA_INFO" | grep -q "ResourceNotFound\|NotFound\|does not exist"; then
            echo "   ‚ö†Ô∏è  Warning: Cannot access Static Web App via Azure CLI"
            echo "   This might be a cross-subscription access issue"
            echo "   Error: $SWA_INFO"
            echo ""
            echo "   ‚ÑπÔ∏è  This is OK - deployment via token will still work!"
            echo "   The deployment token method doesn't require Azure CLI access"
          elif echo "$SWA_INFO" | grep -q "AuthorizationFailed\|Forbidden"; then
            echo "   ‚ö†Ô∏è  Warning: Access denied via Azure CLI"
            echo "   Error: $SWA_INFO"
            echo ""
            echo "   ‚ÑπÔ∏è  This is OK - deployment via token will still work!"
            echo "   The deployment token method doesn't require Azure CLI access"
          else
            echo "   ‚úÖ Can access Static Web App:"
            # Try to parse with jq, fallback to raw output
            if command -v jq >/dev/null 2>&1; then
              echo "$SWA_INFO" | jq -r '. | "      Name: \(.name)\n      URL: \(.defaultHostname)\n      Location: \(.location)"' 2>/dev/null || echo "$SWA_INFO"
            else
              echo "$SWA_INFO"
            fi
          fi
          
          echo ""
          echo "‚úÖ Azure connectivity verification complete"
          echo ""
          echo "‚ÑπÔ∏è  Note: Deployment via token doesn't require Azure CLI access"
          echo "   Files upload directly to Azure Static Web App"
          echo "   Check deployment history in Azure Portal ‚Üí Static Web App ‚Üí Deployment history"

      - name: Deploy Backend
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_WEBAPP_NAME || secrets.DEV_AZURE_WEBAPP_NAME }}
          package: ${{ github.workspace }}/backend-deploy.zip
          startup-command: 'npm start'

      - name: Configure Backend Settings
        run: |
          az webapp config appsettings set \
            --name ${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_WEBAPP_NAME || secrets.DEV_AZURE_WEBAPP_NAME }} \
            --resource-group ${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_RESOURCE_GROUP || secrets.DEV_AZURE_RESOURCE_GROUP }} \
            --settings \
              NODE_ENV="${{ steps.env.outputs.env }}" \
              PORT="8080" \
              FRONTEND_URL="${{ github.ref == 'refs/heads/main' && secrets.PROD_FRONTEND_URL || secrets.DEV_FRONTEND_URL }}" \
              AZURE_TENANT_ID="${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_TENANT_ID || secrets.DEV_AZURE_TENANT_ID }}" \
              AZURE_CLIENT_ID="${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_CLIENT_ID || secrets.DEV_AZURE_CLIENT_ID }}" \
              COSMOS_ENDPOINT="${{ github.ref == 'refs/heads/main' && secrets.PROD_COSMOS_ENDPOINT || secrets.DEV_COSMOS_ENDPOINT }}" \
              COSMOS_KEY="${{ github.ref == 'refs/heads/main' && secrets.PROD_COSMOS_KEY || secrets.DEV_COSMOS_KEY }}" \
              COSMOS_DATABASE="${{ github.ref == 'refs/heads/main' && secrets.PROD_COSMOS_DATABASE || secrets.DEV_COSMOS_DATABASE }}" \
              GOOGLE_CLIENT_ID="${{ github.ref == 'refs/heads/main' && secrets.PROD_GOOGLE_CLIENT_ID || secrets.DEV_GOOGLE_CLIENT_ID }}" \
              MAGIC_LINK_JWT_SECRET="${{ github.ref == 'refs/heads/main' && secrets.PROD_MAGIC_LINK_JWT_SECRET || secrets.DEV_MAGIC_LINK_JWT_SECRET }}" \
              MAGIC_LINK_TTL_MINUTES="1440" \
              AZURE_COMMUNICATION_CONNECTION_STRING="${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_COMMUNICATION_CONNECTION_STRING || secrets.DEV_AZURE_COMMUNICATION_CONNECTION_STRING }}" \
              AZURE_COMMUNICATION_SENDER_EMAIL="${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_COMMUNICATION_SENDER_EMAIL || secrets.DEV_AZURE_COMMUNICATION_SENDER_EMAIL }}" \
              SCM_DO_BUILD_DURING_DEPLOYMENT="true" \
              WEBSITES_ENABLE_APP_SERVICE_STORAGE="false" \
            --output none

      - name: Restart Backend
        run: |
          az webapp restart \
            --name ${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_WEBAPP_NAME || secrets.DEV_AZURE_WEBAPP_NAME }} \
            --resource-group ${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_RESOURCE_GROUP || secrets.DEV_AZURE_RESOURCE_GROUP }}

      # Deploy Frontend
      - name: Setup Node.js for Frontend
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Frontend Dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Clean Frontend Build
        working-directory: ./frontend
        run: |
          echo "üßπ Cleaning previous build..."
          rm -rf dist
          rm -rf node_modules/.vite
          echo "‚úÖ Clean completed"

      - name: Build Frontend
        working-directory: ./frontend
        env:
          VITE_MSAL_CLIENT_ID: ${{ github.ref == 'refs/heads/main' && secrets.PROD_VITE_MSAL_CLIENT_ID || secrets.DEV_VITE_MSAL_CLIENT_ID }}
          VITE_MSAL_TENANT_ID: ${{ github.ref == 'refs/heads/main' && secrets.PROD_VITE_MSAL_TENANT_ID || secrets.DEV_VITE_MSAL_TENANT_ID }}
          VITE_GOOGLE_CLIENT_ID: ${{ github.ref == 'refs/heads/main' && secrets.PROD_VITE_GOOGLE_CLIENT_ID || secrets.DEV_VITE_GOOGLE_CLIENT_ID }}
          VITE_API_BASE_URL: ${{ github.ref == 'refs/heads/main' && secrets.PROD_VITE_API_BASE_URL || secrets.DEV_VITE_API_BASE_URL }}
        run: |
          echo "üî® Building frontend with latest code..."
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          npm run build
          echo "‚úÖ Build completed"
          echo "üìã Build output size: $(du -sh dist | cut -f1)"
          
          # Inject build timestamp into index.html for cache busting
          if [ -f dist/index.html ]; then
            BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            BUILD_COMMIT="${{ github.sha }}"
            echo "   Injecting build metadata into index.html..."
            # Use # as delimiter to avoid conflicts with | in the replacement string
            sed -i.bak "s#</head>#<!-- Build: $BUILD_TIME | Commit: $BUILD_COMMIT --></head>#" dist/index.html
            rm -f dist/index.html.bak
            echo "   ‚úÖ Build metadata injected"
          fi

      - name: Verify Build Output
        working-directory: ./frontend
        run: |
          echo "üìã Verifying build output..."
          echo "Build timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""
          echo "Build files:"
          find dist -type f -name "*.js" -o -name "*.css" -o -name "*.html" | head -10
          echo ""
          echo "Total build size: $(du -sh dist | cut -f1)"
          echo ""
          echo "üîç Verifying latest code is in build..."
          echo "Checking for 'Organizer Admin Name' in built files..."
          if grep -r "Organizer Admin Name" dist/ 2>/dev/null | head -1; then
            echo "‚úÖ Found 'Organizer Admin Name' in build - latest code is included!"
          else
            echo "‚ö†Ô∏è  WARNING: 'Organizer Admin Name' not found in build!"
            echo "   This might indicate the build is using old code."
            echo "   Checking what's actually in the build..."
            grep -r "Organiser\|Organizer" dist/ 2>/dev/null | head -3 || echo "   No organizer-related text found"
          fi
          echo ""
          echo "üìÑ Checking index.html for cache-busting..."
          if [ -f dist/index.html ]; then
            echo "   index.html size: $(wc -l < dist/index.html) lines"
            echo "   index.html contains:"
            grep -o 'assets/[^"]*\.js' dist/index.html | head -3 || echo "   No JS files referenced"
          fi
          echo ""
          echo "‚úÖ Build verification complete"

      - name: Deploy Frontend
        working-directory: ./frontend
        run: |
          echo "üöÄ Deploying to Azure Static Web App..."
          echo "Deployment timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""
          
          # Verify we're deploying the right files
          echo "üì¶ Files to deploy:"
          ls -lh dist/ | head -10
          echo ""
          echo "üîç Final verification - checking built files contain latest code:"
          if grep -r "Organizer Admin Name" dist/ 2>/dev/null | head -1; then
            echo "   ‚úÖ Confirmed: Latest code ('Organizer Admin Name') is in build"
          else
            echo "   ‚ö†Ô∏è  WARNING: Latest code might not be in build!"
          fi
          echo ""
          
          SWA_NAME="${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_STATIC_WEB_APP_NAME || secrets.DEV_AZURE_STATIC_WEB_APP_NAME }}"
          RESOURCE_GROUP="${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_RESOURCE_GROUP || secrets.DEV_AZURE_RESOURCE_GROUP }}"
          DEPLOY_TOKEN="${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_STATIC_WEB_APP_DEPLOYMENT_TOKEN || secrets.DEV_AZURE_STATIC_WEB_APP_DEPLOYMENT_TOKEN }}"
          
          echo "Static Web App: $SWA_NAME"
          echo "Resource Group: $RESOURCE_GROUP"
          echo ""
          echo "Starting deployment..."
          echo ""
          
          # Deploy using the CLI
          # Capture output to verify deployment started
          DEPLOY_OUTPUT=$(npx --yes @azure/static-web-apps-cli deploy ./dist \
            --deployment-token "$DEPLOY_TOKEN" \
            --env production \
            --no-use-keychain 2>&1)
          
          DEPLOY_EXIT_CODE=$?
          
          echo "$DEPLOY_OUTPUT"
          echo ""
          
          if [ $DEPLOY_EXIT_CODE -ne 0 ]; then
            echo "‚ùå Deployment command failed with exit code: $DEPLOY_EXIT_CODE"
            echo "   Check the output above for errors"
            exit 1
          fi
          
          # Check if deployment was initiated
          if echo "$DEPLOY_OUTPUT" | grep -qi "deploy\|upload\|preparing"; then
            echo "‚úÖ Deployment initiated successfully"
          else
            echo "‚ö†Ô∏è  Warning: Deployment output doesn't show expected messages"
            echo "   But exit code was 0, so continuing..."
          fi
          
          echo ""
          echo "‚è≥ Waiting for deployment to complete..."
          echo "   Note: Deployment token method uploads files directly to Azure"
          echo "   Standard deployment time is 2-3 minutes"
          echo ""
          
          # Wait for deployment to complete
          ELAPSED=0
          TOTAL_WAIT=180  # 3 minutes
          INTERVAL=15     # Show progress every 15 seconds
          
          while [ $ELAPSED -lt $TOTAL_WAIT ]; do
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
            REMAINING=$((TOTAL_WAIT - ELAPSED))
            echo "   ‚è≥ Deployment in progress... (${ELAPSED}s / ${TOTAL_WAIT}s - ${REMAINING}s remaining)"
          done
          
          echo ""
          echo "‚úÖ Wait period completed (3 minutes)"
          echo ""
          echo "üìã Deployment Summary:"
          echo "   ‚Ä¢ Commit: ${{ github.sha }}"
          echo "   ‚Ä¢ Branch: ${{ github.ref_name }}"
          echo "   ‚Ä¢ Deployed at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo ""
          echo "üí° To see changes:"
          echo "   1. Wait 1-2 more minutes for Azure CDN to update"
          echo "   2. Hard refresh browser: Ctrl+Shift+R (Windows) or Cmd+Shift+R (Mac)"
          echo "   3. Or clear browser cache completely"
          echo "   4. Check Azure Portal ‚Üí Static Web App ‚Üí Deployment history"
          echo ""
          echo "‚úÖ Frontend deployment completed"

      - name: Cleanup Deployment Files
        if: always()
        run: rm -f backend-deploy.zip

      - name: Cleanup Runner Disk Space
        if: always()
        run: |
          echo "üßπ Cleaning up runner disk space..."
          
          # Clean old work directories (older than 7 days)
          echo "Cleaning old work directories..."
          find "${{ runner.workspace }}/.." -maxdepth 1 -type d -name "_work" -exec find {} -type d -mtime +7 -exec rm -rf {} + \; 2>/dev/null || true
          
          # Clean old diagnostic logs (older than 3 days)
          echo "Cleaning old diagnostic logs..."
          find /opt/actions-runner/_diag -name "*.log" -mtime +3 -delete 2>/dev/null || true
          
          # Clean npm cache in work directory
          echo "Cleaning npm cache..."
          find "${{ runner.workspace }}/.." -type d -name ".npm" -exec rm -rf {} + 2>/dev/null || true
          
          # Clean temporary files
          echo "Cleaning temporary files..."
          find "${{ runner.temp }}" -type f -mtime +1 -delete 2>/dev/null || true
          
          # Clean old archives and downloads
          echo "Cleaning old archives..."
          find "${{ runner.workspace }}/.." -name "*.tar.gz" -mtime +1 -delete 2>/dev/null || true
          find "${{ runner.workspace }}/.." -name "*.zip" -mtime +1 -delete 2>/dev/null || true
          
          # Show disk space after cleanup
          echo ""
          echo "üìä Disk space after cleanup:"
          df -h / | tail -1
          echo ""
          echo "‚úÖ Cleanup completed"

      - name: Deployment Complete
        run: |
          echo "‚úÖ‚úÖ‚úÖ Deployment Complete! ‚úÖ‚úÖ‚úÖ"
          echo "Environment: ${{ steps.env.outputs.env }}"
          echo "Branch: ${{ github.ref_name }}"
