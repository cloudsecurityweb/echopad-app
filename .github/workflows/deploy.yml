name: Deploy Application

on:
  push:
    branches:
      - main
      - develop

env:
  NODE_VERSION: '20'

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Test Runner
        run: |
          echo "âœ… Runner is working!"
          echo "OS: $(uname -a)"
          echo "User: $(whoami)"
          echo "PWD: $(pwd)"
          echo "Git version: $(git --version 2>&1 || echo 'Git not found')"
          echo "Node version: $(node --version 2>&1 || echo 'Node not found')"
          echo "NPM version: $(npm --version 2>&1 || echo 'NPM not found')"
          echo "Azure CLI: $(az --version 2>&1 | head -1 || echo 'Azure CLI not found')"
          ls -la
          echo "âœ… Test step completed"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine Environment
        id: env
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "env=production" >> $GITHUB_OUTPUT
            echo "prefix=PROD" >> $GITHUB_OUTPUT
            echo "âœ… Deploying to PRODUCTION"
          else
            echo "env=development" >> $GITHUB_OUTPUT
            echo "prefix=DEV" >> $GITHUB_OUTPUT
            echo "âœ… Deploying to DEVELOPMENT"
          fi
          echo "Branch: ${{ github.ref_name }}"
          echo "Ref: ${{ github.ref }}"

      # Deploy Backend
      - name: Setup Node.js for Backend
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Backend Dependencies
        working-directory: ./backend
        run: npm ci

      - name: Create Backend Deployment Package
        working-directory: ./backend
        run: |
          zip -r ../backend-deploy.zip . \
            -x "node_modules/*" \
            -x ".git/*" \
            -x "*.log" \
            -x "*.md" \
            -x ".env*" \
            -x "test-*.js" \
            -x "*.spec.js" \
            -x ".DS_Store" \
            -x "*.zip" \
            -x "*.sh" \
            -x "*.ps1" \
            -x "create-*.ps1" \
            > /dev/null 2>&1
          echo "âœ… Backend package created"
          ls -lh ../backend-deploy.zip || echo "âŒ Package not found!"

      - name: Verify Secrets
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            if [ -z "${{ secrets.PROD_AZURE_CREDS }}" ]; then
              echo "âŒ ERROR: PROD_AZURE_CREDS secret is missing!"
              exit 1
            fi
            echo "âœ… PROD secrets verified"
          else
            if [ -z "${{ secrets.DEV_AZURE_CREDS }}" ]; then
              echo "âŒ ERROR: DEV_AZURE_CREDS secret is missing!"
              exit 1
            fi
            echo "âœ… DEV secrets verified"
          fi

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_CREDS || secrets.DEV_AZURE_CREDS }}

      - name: Verify Azure Access and Set Subscription
        run: |
          echo "ðŸ” Verifying Azure access and subscription..."
          echo ""
          
          # Show current account
          echo "Current Azure account:"
          az account show --query "{name:name, id:id, tenantId:tenantId}" -o table || {
            echo "âŒ Cannot get account info"
            exit 1
          }
          
          # Set correct subscription based on environment
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            # PROD subscription
            SUBSCRIPTION_ID="c9ca9a88-e079-4b0d-a4ad-ed340a5d30fb"
            echo ""
            echo "Setting PROD subscription: $SUBSCRIPTION_ID"
          else
            # DEV subscription
            SUBSCRIPTION_ID="c31376b6-ec72-4a1a-9fb6-ec8c53edf6d2"
            echo ""
            echo "Setting DEV subscription: $SUBSCRIPTION_ID"
          fi
          
          az account set --subscription "$SUBSCRIPTION_ID"
          echo "âœ… Subscription set"
          
          # Verify we can access the Static Web App
          SWA_NAME="${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_STATIC_WEB_APP_NAME || secrets.DEV_AZURE_STATIC_WEB_APP_NAME }}"
          RESOURCE_GROUP="${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_RESOURCE_GROUP || secrets.DEV_AZURE_RESOURCE_GROUP }}"
          
          echo ""
          echo "Testing access to Static Web App:"
          echo "   Name: $SWA_NAME"
          echo "   Resource Group: $RESOURCE_GROUP"
          
          SWA_ACCESS=$(az staticwebapp show \
            --name "$SWA_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --query "name" -o tsv 2>&1)
          
          if echo "$SWA_ACCESS" | grep -q "ResourceNotFound\|NotFound\|AuthorizationFailed\|Forbidden"; then
            echo "   âŒ Cannot access Static Web App!"
            echo "   Error: $SWA_ACCESS"
            echo "   This indicates cross-account or permission issue"
            echo "   Deployment will work via token, but status checking will fail"
          else
            echo "   âœ… Can access Static Web App: $SWA_ACCESS"
          fi

      - name: Verify Azure Connectivity
        run: |
          echo "ðŸ” Verifying Azure connectivity and subscription access..."
          echo ""
          
          # Show current account and subscription
          echo "ðŸ“‹ Current Azure account:"
          az account show --query "{name:name, id:id, tenantId:tenantId}" -o table || {
            echo "âŒ Cannot get account info"
            exit 1
          }
          
          # List available subscriptions
          echo ""
          echo "ðŸ“‹ Available subscriptions:"
          az account list --query "[].{name:name, id:id, isDefault:isDefault}" -o table || {
            echo "âŒ Cannot list subscriptions"
            exit 1
          }
          
          # Get Static Web App details
          SWA_NAME="${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_STATIC_WEB_APP_NAME || secrets.DEV_AZURE_STATIC_WEB_APP_NAME }}"
          RESOURCE_GROUP="${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_RESOURCE_GROUP || secrets.DEV_AZURE_RESOURCE_GROUP }}"
          
          echo ""
          echo "ðŸ” Checking access to Static Web App:"
          echo "   Name: $SWA_NAME"
          echo "   Resource Group: $RESOURCE_GROUP"
          
          # Try to get the Static Web App
          SWA_INFO=$(az staticwebapp show \
            --name "$SWA_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --query "{name:name, defaultHostname:defaultHostname, location:location}" -o json 2>&1)
          
          if echo "$SWA_INFO" | grep -q "ResourceNotFound\|NotFound\|does not exist"; then
            echo "   âŒ Static Web App not found or no access"
            echo "   This might be a cross-subscription access issue"
            echo "   Error: $SWA_INFO"
            exit 1
          elif echo "$SWA_INFO" | grep -q "AuthorizationFailed\|Forbidden"; then
            echo "   âŒ Access denied - insufficient permissions"
            echo "   Error: $SWA_INFO"
            exit 1
          else
            echo "   âœ… Can access Static Web App:"
            echo "$SWA_INFO" | jq -r '. | "      Name: \(.name)\n      URL: \(.defaultHostname)\n      Location: \(.location)"' 2>/dev/null || echo "$SWA_INFO"
          fi
          
          # Test deployment list access
          echo ""
          echo "ðŸ” Testing deployment list access:"
          DEPLOYMENT_LIST=$(az staticwebapp deployment list \
            --name "$SWA_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --query "[0:2]" -o json 2>&1)
          
          if echo "$DEPLOYMENT_LIST" | grep -q "ResourceNotFound\|NotFound\|does not exist\|AuthorizationFailed\|Forbidden"; then
            echo "   âš ï¸  Cannot access deployment list"
            echo "   This means we cannot verify deployment status"
            echo "   Deployment will still work, but status checking will be limited"
          else
            echo "   âœ… Can access deployment list"
            DEPLOYMENT_COUNT=$(echo "$DEPLOYMENT_LIST" | jq 'length' 2>/dev/null || echo "0")
            echo "   Found $DEPLOYMENT_COUNT recent deployment(s)"
          fi
          
          echo ""
          echo "âœ… Azure connectivity verification complete"

      - name: Deploy Backend
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_WEBAPP_NAME || secrets.DEV_AZURE_WEBAPP_NAME }}
          package: ${{ github.workspace }}/backend-deploy.zip
          startup-command: 'npm start'

      - name: Configure Backend Settings
        run: |
          az webapp config appsettings set \
            --name ${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_WEBAPP_NAME || secrets.DEV_AZURE_WEBAPP_NAME }} \
            --resource-group ${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_RESOURCE_GROUP || secrets.DEV_AZURE_RESOURCE_GROUP }} \
            --settings \
              NODE_ENV="${{ steps.env.outputs.env }}" \
              PORT="8080" \
              FRONTEND_URL="${{ github.ref == 'refs/heads/main' && secrets.PROD_FRONTEND_URL || secrets.DEV_FRONTEND_URL }}" \
              AZURE_TENANT_ID="${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_TENANT_ID || secrets.DEV_AZURE_TENANT_ID }}" \
              AZURE_CLIENT_ID="${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_CLIENT_ID || secrets.DEV_AZURE_CLIENT_ID }}" \
              COSMOS_ENDPOINT="${{ github.ref == 'refs/heads/main' && secrets.PROD_COSMOS_ENDPOINT || secrets.DEV_COSMOS_ENDPOINT }}" \
              COSMOS_KEY="${{ github.ref == 'refs/heads/main' && secrets.PROD_COSMOS_KEY || secrets.DEV_COSMOS_KEY }}" \
              COSMOS_DATABASE="${{ github.ref == 'refs/heads/main' && secrets.PROD_COSMOS_DATABASE || secrets.DEV_COSMOS_DATABASE }}" \
              GOOGLE_CLIENT_ID="${{ github.ref == 'refs/heads/main' && secrets.PROD_GOOGLE_CLIENT_ID || secrets.DEV_GOOGLE_CLIENT_ID }}" \
              MAGIC_LINK_JWT_SECRET="${{ github.ref == 'refs/heads/main' && secrets.PROD_MAGIC_LINK_JWT_SECRET || secrets.DEV_MAGIC_LINK_JWT_SECRET }}" \
              MAGIC_LINK_TTL_MINUTES="1440" \
              AZURE_COMMUNICATION_CONNECTION_STRING="${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_COMMUNICATION_CONNECTION_STRING || secrets.DEV_AZURE_COMMUNICATION_CONNECTION_STRING }}" \
              AZURE_COMMUNICATION_SENDER_EMAIL="${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_COMMUNICATION_SENDER_EMAIL || secrets.DEV_AZURE_COMMUNICATION_SENDER_EMAIL }}" \
              SCM_DO_BUILD_DURING_DEPLOYMENT="true" \
              WEBSITES_ENABLE_APP_SERVICE_STORAGE="false" \
            --output none

      - name: Restart Backend
        run: |
          az webapp restart \
            --name ${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_WEBAPP_NAME || secrets.DEV_AZURE_WEBAPP_NAME }} \
            --resource-group ${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_RESOURCE_GROUP || secrets.DEV_AZURE_RESOURCE_GROUP }}

      # Deploy Frontend
      - name: Setup Node.js for Frontend
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Frontend Dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Clean Frontend Build
        working-directory: ./frontend
        run: |
          echo "ðŸ§¹ Cleaning previous build..."
          rm -rf dist
          rm -rf node_modules/.vite
          echo "âœ… Clean completed"

      - name: Build Frontend
        working-directory: ./frontend
        env:
          VITE_MSAL_CLIENT_ID: ${{ github.ref == 'refs/heads/main' && secrets.PROD_VITE_MSAL_CLIENT_ID || secrets.DEV_VITE_MSAL_CLIENT_ID }}
          VITE_MSAL_TENANT_ID: ${{ github.ref == 'refs/heads/main' && secrets.PROD_VITE_MSAL_TENANT_ID || secrets.DEV_VITE_MSAL_TENANT_ID }}
          VITE_GOOGLE_CLIENT_ID: ${{ github.ref == 'refs/heads/main' && secrets.PROD_VITE_GOOGLE_CLIENT_ID || secrets.DEV_VITE_GOOGLE_CLIENT_ID }}
          VITE_API_BASE_URL: ${{ github.ref == 'refs/heads/main' && secrets.PROD_VITE_API_BASE_URL || secrets.DEV_VITE_API_BASE_URL }}
        run: |
          echo "ðŸ”¨ Building frontend with latest code..."
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          npm run build
          echo "âœ… Build completed"
          echo "ðŸ“‹ Build output size: $(du -sh dist | cut -f1)"
          
          # Inject build timestamp into index.html for cache busting
          if [ -f dist/index.html ]; then
            BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            BUILD_COMMIT="${{ github.sha }}"
            echo "   Injecting build metadata into index.html..."
            sed -i.bak "s|</head>|<!-- Build: $BUILD_TIME | Commit: $BUILD_COMMIT --></head>|" dist/index.html
            rm -f dist/index.html.bak
            echo "   âœ… Build metadata injected"
          fi

      - name: Verify Build Output
        working-directory: ./frontend
        run: |
          echo "ðŸ“‹ Verifying build output..."
          echo "Build timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""
          echo "Build files:"
          find dist -type f -name "*.js" -o -name "*.css" -o -name "*.html" | head -10
          echo ""
          echo "Total build size: $(du -sh dist | cut -f1)"
          echo ""
          echo "ðŸ” Verifying latest code is in build..."
          echo "Checking for 'Organizer Admin Name' in built files..."
          if grep -r "Organizer Admin Name" dist/ 2>/dev/null | head -1; then
            echo "âœ… Found 'Organizer Admin Name' in build - latest code is included!"
          else
            echo "âš ï¸  WARNING: 'Organizer Admin Name' not found in build!"
            echo "   This might indicate the build is using old code."
            echo "   Checking what's actually in the build..."
            grep -r "Organiser\|Organizer" dist/ 2>/dev/null | head -3 || echo "   No organizer-related text found"
          fi
          echo ""
          echo "ðŸ“„ Checking index.html for cache-busting..."
          if [ -f dist/index.html ]; then
            echo "   index.html size: $(wc -l < dist/index.html) lines"
            echo "   index.html contains:"
            grep -o 'assets/[^"]*\.js' dist/index.html | head -3 || echo "   No JS files referenced"
          fi
          echo ""
          echo "âœ… Build verification complete"

      - name: Deploy Frontend
        working-directory: ./frontend
        run: |
          echo "ðŸš€ Deploying to Azure Static Web App..."
          echo "Deployment timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""
          
          # Verify we're deploying the right files
          echo "ðŸ“¦ Files to deploy:"
          ls -lh dist/ | head -10
          echo ""
          echo "ðŸ” Final verification - checking built files contain latest code:"
          if grep -r "Organizer Admin Name" dist/ 2>/dev/null | head -1; then
            echo "   âœ… Confirmed: Latest code ('Organizer Admin Name') is in build"
          else
            echo "   âš ï¸  WARNING: Latest code might not be in build!"
          fi
          echo ""
          
          SWA_NAME="${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_STATIC_WEB_APP_NAME || secrets.DEV_AZURE_STATIC_WEB_APP_NAME }}"
          RESOURCE_GROUP="${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_RESOURCE_GROUP || secrets.DEV_AZURE_RESOURCE_GROUP }}"
          DEPLOY_TOKEN="${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_STATIC_WEB_APP_DEPLOYMENT_TOKEN || secrets.DEV_AZURE_STATIC_WEB_APP_DEPLOYMENT_TOKEN }}"
          
          echo "Static Web App: $SWA_NAME"
          echo "Resource Group: $RESOURCE_GROUP"
          echo ""
          echo "Starting deployment..."
          echo ""
          
          # Deploy using the CLI
          # Capture output to verify deployment started
          DEPLOY_OUTPUT=$(npx --yes @azure/static-web-apps-cli deploy ./dist \
            --deployment-token "$DEPLOY_TOKEN" \
            --env production \
            --no-use-keychain 2>&1)
          
          DEPLOY_EXIT_CODE=$?
          
          echo "$DEPLOY_OUTPUT"
          echo ""
          
          if [ $DEPLOY_EXIT_CODE -ne 0 ]; then
            echo "âŒ Deployment command failed with exit code: $DEPLOY_EXIT_CODE"
            echo "   Check the output above for errors"
            exit 1
          fi
          
          # Check if deployment was initiated
          if echo "$DEPLOY_OUTPUT" | grep -qi "deploy\|upload\|preparing"; then
            echo "âœ… Deployment initiated successfully"
          else
            echo "âš ï¸  Warning: Deployment output doesn't show expected messages"
            echo "   But exit code was 0, so continuing..."
          fi
          
          echo ""
          echo "â³ Waiting for deployment to complete..."
          echo "   Note: Deployment token method uploads files directly to Azure"
          echo "   Standard deployment time is 2-3 minutes"
          echo ""
          
          # Wait for deployment to complete
          ELAPSED=0
          TOTAL_WAIT=180  # 3 minutes
          INTERVAL=15     # Show progress every 15 seconds
          
          while [ $ELAPSED -lt $TOTAL_WAIT ]; do
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
            REMAINING=$((TOTAL_WAIT - ELAPSED))
            echo "   â³ Deployment in progress... (${ELAPSED}s / ${TOTAL_WAIT}s - ${REMAINING}s remaining)"
          done
          
          echo ""
          echo "âœ… Wait period completed (3 minutes)"
          echo ""
          echo "ðŸ“‹ Deployment Summary:"
          echo "   â€¢ Commit: ${{ github.sha }}"
          echo "   â€¢ Branch: ${{ github.ref_name }}"
          echo "   â€¢ Deployed at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo ""
          echo "ðŸ’¡ To see changes:"
          echo "   1. Wait 1-2 more minutes for Azure CDN to update"
          echo "   2. Hard refresh browser: Ctrl+Shift+R (Windows) or Cmd+Shift+R (Mac)"
          echo "   3. Or clear browser cache completely"
          echo "   4. Check Azure Portal â†’ Static Web App â†’ Deployment history"
          echo ""
          echo "âœ… Frontend deployment completed"

      - name: Cleanup Deployment Files
        if: always()
        run: rm -f backend-deploy.zip

      - name: Cleanup Runner Disk Space
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up runner disk space..."
          
          # Clean old work directories (older than 7 days)
          echo "Cleaning old work directories..."
          find "${{ runner.workspace }}/.." -maxdepth 1 -type d -name "_work" -exec find {} -type d -mtime +7 -exec rm -rf {} + \; 2>/dev/null || true
          
          # Clean old diagnostic logs (older than 3 days)
          echo "Cleaning old diagnostic logs..."
          find /opt/actions-runner/_diag -name "*.log" -mtime +3 -delete 2>/dev/null || true
          
          # Clean npm cache in work directory
          echo "Cleaning npm cache..."
          find "${{ runner.workspace }}/.." -type d -name ".npm" -exec rm -rf {} + 2>/dev/null || true
          
          # Clean temporary files
          echo "Cleaning temporary files..."
          find "${{ runner.temp }}" -type f -mtime +1 -delete 2>/dev/null || true
          
          # Clean old archives and downloads
          echo "Cleaning old archives..."
          find "${{ runner.workspace }}/.." -name "*.tar.gz" -mtime +1 -delete 2>/dev/null || true
          find "${{ runner.workspace }}/.." -name "*.zip" -mtime +1 -delete 2>/dev/null || true
          
          # Show disk space after cleanup
          echo ""
          echo "ðŸ“Š Disk space after cleanup:"
          df -h / | tail -1
          echo ""
          echo "âœ… Cleanup completed"

      - name: Deployment Complete
        run: |
          echo "âœ…âœ…âœ… Deployment Complete! âœ…âœ…âœ…"
          echo "Environment: ${{ steps.env.outputs.env }}"
          echo "Branch: ${{ github.ref_name }}"
