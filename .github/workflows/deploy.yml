name: Deploy Backend and Frontend

on:
  push:
    branches:
      - main
      - develop

env:
  NODE_VERSION: 20

jobs:
  deploy:
    name: Deploy Application
    runs-on: self-hosted

    steps:
    # -------------------------------------------------
    # Checkout
    # -------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # -------------------------------------------------
    # Determine Environment
    # -------------------------------------------------
    - name: Determine environment
      id: env
      shell: bash
      run: |
        if [ "${GITHUB_REF}" = "refs/heads/main" ]; then
          echo "ENV=production" >> $GITHUB_OUTPUT
          echo "Deploying to PRODUCTION"
        else
          echo "ENV=development" >> $GITHUB_OUTPUT
          echo "Deploying to DEVELOPMENT"
        fi

    # -------------------------------------------------
    # Azure Login (Using creds JSON format)
    # -------------------------------------------------
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDS }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    # -------------------------------------------------
    # Verify Azure Login
    # -------------------------------------------------
    - name: Verify Azure Login
      run: az account show

    # -------------------------------------------------
    # Backend Build
    # -------------------------------------------------
    - name: Setup Node.js (Backend)
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Install backend dependencies
      working-directory: backend
      run: npm ci

    - name: Package backend
      working-directory: backend
      shell: bash
      run: |
        zip -r ../backend.zip . \
          -x node_modules/\* .git/\*
        ls -lh ../backend.zip

    # -------------------------------------------------
    # Backend Deploy (App Service)
    # -------------------------------------------------
    - name: Deploy backend to Azure App Service
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ secrets.AZURE_BACKEND_APP_NAME }}
        package: backend.zip
        startup-command: npm start

    - name: Restart backend
      run: |
        az webapp restart \
          --name "${{ secrets.AZURE_BACKEND_APP_NAME }}" \
          --resource-group "${{ secrets.AZURE_BACKEND_RG }}"

    # -------------------------------------------------
    # Frontend Build
    # -------------------------------------------------
    - name: Setup Node.js (Frontend)
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Install frontend dependencies
      working-directory: frontend
      run: npm ci

    - name: Build frontend
      working-directory: frontend
      env:
        VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
        VITE_MSAL_CLIENT_ID: ${{ secrets.VITE_MSAL_CLIENT_ID }}
        VITE_MSAL_TENANT_ID: ${{ secrets.VITE_MSAL_TENANT_ID }}
      run: |
        npm run build
        du -sh dist

    # -------------------------------------------------
    # Frontend Deploy (Static Web Apps ‚Äì PRODUCTION)
    # -------------------------------------------------
    - name: Deploy frontend and wait until live
      shell: bash
      env:
        DEPLOY_TOKEN: ${{ secrets.AZURE_SWA_DEPLOY_TOKEN }}
        SWA_NAME: ${{ secrets.AZURE_SWA_NAME }}
        RESOURCE_GROUP: ${{ secrets.AZURE_SWA_RG }}
      run: |
        set -euo pipefail

        echo "üöÄ Deploying frontend to PRODUCTION"

        npx --yes @azure/static-web-apps-cli deploy ./frontend/dist \
          --deployment-token "$DEPLOY_TOKEN" \
          --env production \
          --no-use-keychain

        echo "üîç Fetching Static Web App hostname"
        HOSTNAME=$(az staticwebapp show \
          --name "$SWA_NAME" \
          --resource-group "$RESOURCE_GROUP" \
          --query "defaultHostname" -o tsv)

        FRONTEND_URL="https://$HOSTNAME"
        echo "üåç Frontend URL: $FRONTEND_URL"

        echo "‚è≥ Waiting until frontend is reachable..."
        while true; do
          sleep 15
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$FRONTEND_URL" || true)
          if [ "$STATUS" = "200" ]; then
            echo "‚úÖ Frontend is LIVE"
            break
          fi
          echo "‚è≥ Still waiting... HTTP $STATUS"
        done

    # -------------------------------------------------
    # Cleanup
    # -------------------------------------------------
    - name: Cleanup
      if: always()
      run: |
        rm -f backend.zip
        echo "‚úÖ Deployment completed for ${{ steps.env.outputs.ENV }}"
