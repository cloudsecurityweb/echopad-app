name: Deploy Application

on:
  push:
    branches:
      - main
      - develop

env:
  NODE_VERSION: '20'

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Test Runner
        run: |
          echo "âœ… Runner is working!"
          echo "OS: $(uname -a)"
          echo "User: $(whoami)"
          echo "PWD: $(pwd)"
          echo "Git version: $(git --version 2>&1 || echo 'Git not found')"
          echo "Node version: $(node --version 2>&1 || echo 'Node not found')"
          echo "NPM version: $(npm --version 2>&1 || echo 'NPM not found')"
          echo "Azure CLI: $(az --version 2>&1 | head -1 || echo 'Azure CLI not found')"
          ls -la
          echo "âœ… Test step completed"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine Environment
        id: env
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "env=production" >> $GITHUB_OUTPUT
            echo "prefix=PROD" >> $GITHUB_OUTPUT
            echo "âœ… Deploying to PRODUCTION"
          else
            echo "env=development" >> $GITHUB_OUTPUT
            echo "prefix=DEV" >> $GITHUB_OUTPUT
            echo "âœ… Deploying to DEVELOPMENT"
          fi
          echo "Branch: ${{ github.ref_name }}"
          echo "Ref: ${{ github.ref }}"

      # Deploy Backend
      - name: Setup Node.js for Backend
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Backend Dependencies
        working-directory: ./backend
        run: npm ci

      - name: Create Backend Deployment Package
        working-directory: ./backend
        run: |
          zip -r ../backend-deploy.zip . \
            -x "node_modules/*" \
            -x ".git/*" \
            -x "*.log" \
            -x "*.md" \
            -x ".env*" \
            -x "test-*.js" \
            -x "*.spec.js" \
            -x ".DS_Store" \
            -x "*.zip" \
            -x "*.sh" \
            -x "*.ps1" \
            -x "create-*.ps1" \
            > /dev/null 2>&1
          echo "âœ… Backend package created"
          ls -lh ../backend-deploy.zip || echo "âŒ Package not found!"

      - name: Verify Secrets
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            if [ -z "${{ secrets.PROD_AZURE_CREDS }}" ]; then
              echo "âŒ ERROR: PROD_AZURE_CREDS secret is missing!"
              exit 1
            fi
            echo "âœ… PROD secrets verified"
          else
            if [ -z "${{ secrets.DEV_AZURE_CREDS }}" ]; then
              echo "âŒ ERROR: DEV_AZURE_CREDS secret is missing!"
              exit 1
            fi
            echo "âœ… DEV secrets verified"
          fi

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_CREDS || secrets.DEV_AZURE_CREDS }}

      - name: Deploy Backend
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_WEBAPP_NAME || secrets.DEV_AZURE_WEBAPP_NAME }}
          package: ${{ github.workspace }}/backend-deploy.zip
          startup-command: 'npm start'

      - name: Configure Backend Settings
        run: |
          az webapp config appsettings set \
            --name ${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_WEBAPP_NAME || secrets.DEV_AZURE_WEBAPP_NAME }} \
            --resource-group ${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_RESOURCE_GROUP || secrets.DEV_AZURE_RESOURCE_GROUP }} \
            --settings \
              NODE_ENV="${{ steps.env.outputs.env }}" \
              PORT="8080" \
              FRONTEND_URL="${{ github.ref == 'refs/heads/main' && secrets.PROD_FRONTEND_URL || secrets.DEV_FRONTEND_URL }}" \
              AZURE_TENANT_ID="${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_TENANT_ID || secrets.DEV_AZURE_TENANT_ID }}" \
              AZURE_CLIENT_ID="${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_CLIENT_ID || secrets.DEV_AZURE_CLIENT_ID }}" \
              COSMOS_ENDPOINT="${{ github.ref == 'refs/heads/main' && secrets.PROD_COSMOS_ENDPOINT || secrets.DEV_COSMOS_ENDPOINT }}" \
              COSMOS_KEY="${{ github.ref == 'refs/heads/main' && secrets.PROD_COSMOS_KEY || secrets.DEV_COSMOS_KEY }}" \
              COSMOS_DATABASE="${{ github.ref == 'refs/heads/main' && secrets.PROD_COSMOS_DATABASE || secrets.DEV_COSMOS_DATABASE }}" \
              GOOGLE_CLIENT_ID="${{ github.ref == 'refs/heads/main' && secrets.PROD_GOOGLE_CLIENT_ID || secrets.DEV_GOOGLE_CLIENT_ID }}" \
              MAGIC_LINK_JWT_SECRET="${{ github.ref == 'refs/heads/main' && secrets.PROD_MAGIC_LINK_JWT_SECRET || secrets.DEV_MAGIC_LINK_JWT_SECRET }}" \
              MAGIC_LINK_TTL_MINUTES="1440" \
              AZURE_COMMUNICATION_CONNECTION_STRING="${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_COMMUNICATION_CONNECTION_STRING || secrets.DEV_AZURE_COMMUNICATION_CONNECTION_STRING }}" \
              AZURE_COMMUNICATION_SENDER_EMAIL="${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_COMMUNICATION_SENDER_EMAIL || secrets.DEV_AZURE_COMMUNICATION_SENDER_EMAIL }}" \
              SCM_DO_BUILD_DURING_DEPLOYMENT="true" \
              WEBSITES_ENABLE_APP_SERVICE_STORAGE="false" \
            --output none

      - name: Restart Backend
        run: |
          az webapp restart \
            --name ${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_WEBAPP_NAME || secrets.DEV_AZURE_WEBAPP_NAME }} \
            --resource-group ${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_RESOURCE_GROUP || secrets.DEV_AZURE_RESOURCE_GROUP }}

      # Deploy Frontend
      - name: Setup Node.js for Frontend
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Frontend Dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build Frontend
        working-directory: ./frontend
        env:
          VITE_MSAL_CLIENT_ID: ${{ github.ref == 'refs/heads/main' && secrets.PROD_VITE_MSAL_CLIENT_ID || secrets.DEV_VITE_MSAL_CLIENT_ID }}
          VITE_MSAL_TENANT_ID: ${{ github.ref == 'refs/heads/main' && secrets.PROD_VITE_MSAL_TENANT_ID || secrets.DEV_VITE_MSAL_TENANT_ID }}
          VITE_GOOGLE_CLIENT_ID: ${{ github.ref == 'refs/heads/main' && secrets.PROD_VITE_GOOGLE_CLIENT_ID || secrets.DEV_VITE_GOOGLE_CLIENT_ID }}
          VITE_API_BASE_URL: ${{ github.ref == 'refs/heads/main' && secrets.PROD_VITE_API_BASE_URL || secrets.DEV_VITE_API_BASE_URL }}
        run: npm run build

      - name: Deploy Frontend
        working-directory: ./frontend
        run: |
          echo "ðŸš€ Deploying to Azure Static Web App using npx..."
          npx --yes @azure/static-web-apps-cli deploy ./dist \
            --deployment-token "${{ github.ref == 'refs/heads/main' && secrets.PROD_AZURE_STATIC_WEB_APP_DEPLOYMENT_TOKEN || secrets.DEV_AZURE_STATIC_WEB_APP_DEPLOYMENT_TOKEN }}" \
            --env production \
            --no-use-keychain
          echo "âœ… Frontend deployment completed"

      - name: Cleanup Deployment Files
        if: always()
        run: rm -f backend-deploy.zip

      - name: Cleanup Runner Disk Space
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up runner disk space..."
          
          # Clean old work directories (older than 7 days)
          echo "Cleaning old work directories..."
          find "${{ runner.workspace }}/.." -maxdepth 1 -type d -name "_work" -exec find {} -type d -mtime +7 -exec rm -rf {} + \; 2>/dev/null || true
          
          # Clean old diagnostic logs (older than 3 days)
          echo "Cleaning old diagnostic logs..."
          find /opt/actions-runner/_diag -name "*.log" -mtime +3 -delete 2>/dev/null || true
          
          # Clean npm cache in work directory
          echo "Cleaning npm cache..."
          find "${{ runner.workspace }}/.." -type d -name ".npm" -exec rm -rf {} + 2>/dev/null || true
          
          # Clean temporary files
          echo "Cleaning temporary files..."
          find "${{ runner.temp }}" -type f -mtime +1 -delete 2>/dev/null || true
          
          # Clean old archives and downloads
          echo "Cleaning old archives..."
          find "${{ runner.workspace }}/.." -name "*.tar.gz" -mtime +1 -delete 2>/dev/null || true
          find "${{ runner.workspace }}/.." -name "*.zip" -mtime +1 -delete 2>/dev/null || true
          
          # Show disk space after cleanup
          echo ""
          echo "ðŸ“Š Disk space after cleanup:"
          df -h / | tail -1
          echo ""
          echo "âœ… Cleanup completed"

      - name: Deployment Complete
        run: |
          echo "âœ…âœ…âœ… Deployment Complete! âœ…âœ…âœ…"
          echo "Environment: ${{ steps.env.outputs.env }}"
          echo "Branch: ${{ github.ref_name }}"
